{% extends "_base.html" %}

{% block content %}

  <div class="body-content">

    <div id="error" class="row"></div>
    <div id="warning" class="row"></div>
    <div id="tip" class="row"></div>

    <div class="row">

      <div>
        <h2>商户配置数据</h2>
      </div>

      <div id="merchantCfgDataToolbar">
        <div class="form-inline" role="form">
          <button id="batchLogin" type="button" class="btn btn-info" onclick="batchLogin()">批量登录</button>
          <button id="closeAll" type="button" class="btn btn-danger" onclick="closeAll()">关闭窗口</button>

          <div class="form-group input-group" style="padding-left: 150px">
            <span>下载日期：</span>
            <div class="input-group">
              <div class="input-icon-group">
                <div class="input-group" style="width:100%">
                  <input id="orderDownloadDate" name="orderDownloadDate" class="form-control"
                         style="width: 100px;" data-provide="datepicker">
                  <span class="input-group-addon">
                  <span class="glyphicon glyphicon-calendar" style="display: inline;"></span>
                </span>
                </div>
              </div>
            </div>
            <button id="batchDownload" type="button" class="btn btn-warning" onclick="batchDownload()">一键下载</button>
            <button class="btn btn-success" type="button" style="width: auto; margin-left: 5px"
                    onclick="mergeOrderDatas()">合并商户订单
            </button>
          </div>
          {#          <div class="form-group">#}
          {#            <span>Limit: </span>#}
          {#            <input name="limit" class="form-control w70" type="number" value="5">#}
          {#          </div>#}
        </div>
      </div>

      <table id="merchantCfgData" data-toggle="table" data-mobile-responsive="true">
        <thead>
        <tr>
          <th data-sortable="true">简称</th>
          <th data-sortable="false">登录账户</th>
          <th data-sortable="true">MCC</th>
          <th data-sortable="false">全称</th>
          <th data-sortable="false">SessionId</th>
          <th data-sortable="true">状态</th>
          <th data-sortable="false">操作</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <div class="row">
      <h2>统计数据</h2>
      <table data-toggle="table">
        <thead>
        <tr>
          <th>门店名称</th>
          <th>交易日期</th>
          <th>总订单金额</th>
          <th>总消费立减金额</th>
          <th>总积分抵扣金额</th>
          <th>总电子券抵扣金额</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <div class="row">
      <h2>订单详细数据</h2>
      <table data-toggle="table" data-search="true"
             data-pagination="true" data-mobile-responsive="true"
             data-show-toggle="false" data-page-size=20
             data-striped="true">
        <thead>
        <tr>
          <th data-sortable="false">订单编号</th>
          <th data-sortable="false">交易日期</th>
          {#<th data-sortable="true">交易时间</th>#}
          <th data-sortable="true">交易卡号</th>
          <th data-sortable="true">订单金额</th>
          <th data-sortable="false">消费立减金额</th>
          {#<th>净收金额</th>#}
          <th data-sortable="false">积分抵扣金额</th>
          <th data-sortable="false">电子券抵扣金额</th>
          <th data-sortable="false">交易类型</th>
          <th data-sortable="false">交易方式</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

  </div>

  <script type="text/javascript">
      var merchantCfgDataTable = $('#merchantCfgData');

      // 参考： http://blog.csdn.net/ning521513/article/details/60744749
      var exportOptions = {
          fileName: 'merchants',
          jsonScope: 'data'
      };

      function initMerchantCfgData() {
          merchantCfgDataTable.bootstrapTable('destroy');
          merchantCfgDataTable.bootstrapTable({
              method: 'get',
              url: '/merchant_info',
              dataType: 'json',
              clickToSelect: true,
              pagination: true,   //是否分页
              uniqueId: 'logonId',
              pageSize: 25,
              striped: true,
              showRefresh: true,
              search: true,
              sidePagination: 'client', // 客户端分页
              showExport: false, // 先不用插件来导出数据了，直接从后台获取
              exportDataType: 'all',
              exportTypes: ['json'],  //导出文件类型
              toolbar: "#merchantCfgDataToolbar",
              exportOptions: exportOptions,
              columns: [{
                  field: 'alias',
                  cellStyle: thinTdStyle
              }, {
                  field: 'logonId',
                  cellStyle: thinTdStyle
              }, {
                  field: 'mcc',
                  align: 'center',
                  cellStyle: thinTdStyle
              }, {
                  field: 'storeName',
                  cellStyle: thinTdStyle
              }, {
                  field: 'sessionId',
                  cellStyle: thinTdStyle
              }, {
                  field: 'status',
                  align: 'center',
                  formatter: statusFormatter,
                  cellStyle: thinTdStyle
              }, {
                  field: 'operate',
                  align: 'center',
                  valign: 'middle',
                  formatter: operateFormatter,
                  events: window.operateEvents
              }],
              onLoadSuccess: function () {
                  console.info("加载商户配置数据成功");
              },
              onLoadError: function () {
                  alert("加载商户配置数据失败");
              }
          })
      }

      function thinTdStyle(value, row, index) {
          return {
              css: {
                  "padding-right": "2px",
                  "padding-left": "2px"
              }
          }
      }

      function statusFormatter(value, row, index) {
          if (row['status']) {
              return '<span class="status-ok glyphicon glyphicon-ok-circle" aria-hidden="true"></span>';
          } else {
              return '<span class="status-bad glyphicon glyphicon-remove-circle" aria-hidden="true"></span>';
          }
      }

      function operateFormatter(value, row, index) {

          var loginTip = ['<a class="login" href="javascript:void(0)">',
              '<button class="btn btn-info" style="padding-top:0px; padding-bottom:0px; margin-left: 5px;">登录</button></a>'].join('');
          if (row['status']) {
              loginTip = ['<a class="login" href="javascript:void(0)">',
                  '<button class="btn btn-success" style="padding-top:0px; padding-bottom:0px; margin-left: 5px;">查看</button></a>'].join('');
          }

          return ['<div>',
              loginTip,
              '<a class="download" href="javascript:void(0)">',
              '<button class="btn btn-warning" style="padding-top:0px; padding-bottom:0px; margin-left: 5px;">下载</button></a>',
              '</div>'
          ].join('');
      }

      function closeAlert() {
          $(".alert-dismissable").fadeTo(2000, 500).slideUp(1000, function () {
              $(".alert-dismissable").slideUp(500);
              $(".alert").alert("close");
          });
      }

      function showError(error, close) {
          if (error) {
              var errorEle = $('#error');
              var errorHtml = errorEle.html() +
                  ['<div class="alert alert-danger alert-dismissable">',
                      '<button type="button" class="close" title="Close" href="#" data-dismiss="alert">&times;</button>',
                      error,
                      '</div>'].join('');
              errorEle.html(errorHtml);
          }
          if (close) {
              closeAlert();
          }
      }

      function showWarning(msg, close) {
          if (msg) {
              var warningEle = $('#warning');
              var errorHtml = warningEle.html() +
                  ['<div class="alert alert-warning alert-dismissable">',
                      '<button type="button" class="close" title="Close" href="#" data-dismiss="alert">&times;</button>',
                      msg,
                      '</div>'].join('');
              warningEle.html(errorHtml);
              if (close) {
                  closeAlert();
              }
          }

      }

      function showTip(tip, close) {
          if (tip) {
              var tipEle = $('#tip');
              var tipHtml = tipEle.html() +
                  ['<div class="alert alert-success alert-dismissable">',
                      '<button type="button" class="close" title="Close" href="#" data-dismiss="alert">&times;</button>',
                      tip,
                      '</div>'].join('');
              tipEle.html(tipHtml);
              if (close) {
                  closeAlert();
              }
          }

      }

      window.operateEvents = {
          'click .login': function (e, value, row, index) {
              var logonId = row['logonId'];
              var alias = row['alias'];
              $.ajax({
                  type: 'POST',
                  url: '/batch_order/manual_login',
                  data: {
                      logonId: logonId
                  },
                  dataType: 'json',
                  success: function (data) {
                      console.info("登录" + logonId + "成功");
                      if (!data['status']) {
                          showError(data['error']);
                      }
                  },
                  error: function (e) {
                      console.error("手动登录" + logonId + "失败", e);
                      showError("手动登录失败[" + alias + logonId + "]" + e);
                  }
              });

          },
          'click .download': function (e, value, row, index) {
              alert(row['logonId']);
          }
      };

      function batchLogin() {
          $.ajax({
              type: 'GET',
              url: '/batch_order/batch_login',
              success: function (data) {
                  if (data.status) {
                      console.info("批量登录成功，登录id为" + data);
                      if (data.data.length > 0) {
                          showTip("批量打开[" + data.data + "],请手动到弹出的网页输入密码+验证码，登录完成后，请手动刷新！");
                      } else {
                          showWarning("所有商户均已登录，无需登录，忽略！")
                      }
                  } else {
                      console.error("批量登录失败" + data);
                      showError("批量登录失败，请重试！" + data);
                  }
              },
              error: function (e) {
                  console.error("批量登录失败" + data);
                  showError("批量登录失败，请重试！");
              }
          });
      }

      function closeAll() {
          $.ajax({
              type: 'GET',
              url: '/batch_order/close_all_drivers',
              success: function (data) {
                  if (data > 0) {
                      console.info("关闭成功" + data);
                      showTip("成功关闭了" + data + "个由selenium打开的页面", true);
                  }
                  // 测试用方便关闭所有通知
                  closeAlert();
              },
              error: function (e) {
                  showWarning("尝试关闭所有selenium打开的页面失败，可以手动关闭剩余页面!");
              }
          });
      }

      function batchDownload() {
          console.info("一键下载，只会下载session生效的");
      }

      function mergeOrderDatas() {
          console.info("合并商户订单")
      }

      $(document).ready(function () {
          initMerchantCfgData();

          var now = new Date();
          var yesterday = new Date();
          yesterday.setDate(now.getDate() - 1);

          var orderDownloadDatePicker = $('#orderDownloadDate');
          orderDownloadDatePicker.datepicker({
              minView: "day", //  选择时间时，最小可以选择到那层；默认是‘hour’也可用0表示
              language: "zh-CN", // 语言
              autoclose: true, //  true:选择时间后窗口自动关闭
              format: 'yyyy-mm-dd', // 文本框时间格式，设置为0,最后时间格式为2017-03-23 17:00:00
              todayBtn: "linked", // 如果此值为true 或 "linked"，则在日期时间选择器组件的底部显示一个 "Today" 按钮用以选择当前日期。
              endDate: now, // 窗口可选时间从今天开始
              orientation: "bottom",    //方向
              todayHighlight: true,
              weekStart: 0
          });

          orderDownloadDatePicker.datepicker("update", yesterday);


      });

  </script>

{% endblock %}
